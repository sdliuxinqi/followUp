<!--pages/doctor/plan/patientRecord/patientRecord.wxml-->
<view class="page-container">
  
  <!-- åŸºæœ¬ä¿¡æ¯ï¼ˆå¿…å¡«é¡¹ï¼‰ -->
  <view class="section-header">
    <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
    <view class="section-count">å¿…å¡«é¡¹</view>
  </view>

  <view class="basic-info-card">
    <view class="info-grid">
      <block wx:for="{{record.requiredAnswers}}" wx:key="index">
        <view class="info-grid-item">
          <view class="info-grid-label">{{item.question}}</view>
          <!-- è§†é¢‘ç±»å‹æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨ -->
          <view wx:if="{{item.type === 'video' && item.answer && item.answer !== 'æœªå¡«å†™'}}" class="video-answer">
            <video 
              class="answer-video" 
              src="{{item.answer}}" 
              controls 
              show-center-play-btn
              enable-play-gesture
            ></video>
          </view>
          <!-- å…¶ä»–ç±»å‹æ˜¾ç¤ºæ–‡æœ¬ç­”æ¡ˆ -->
          <view wx:else class="info-grid-value">{{item.answer}}</view>
        </view>
      </block>
    </view>
  </view>
  
  <!-- æ´»åŠ¨è¯„ä¼°ï¼ˆè§†é¢‘ç­‰ï¼‰ -->
  <view class="section-header" wx:if="{{record.activityAnswers && record.activityAnswers.length > 0}}">
    <view class="section-title">æ´»åŠ¨è¯„ä¼°</view>
    <view class="section-count">{{record.activityAnswers.length}}é¡¹</view>
  </view>

  <view class="basic-info-card" wx:if="{{record.activityAnswers && record.activityAnswers.length > 0}}">
    <view class="info-grid">
      <block wx:for="{{record.activityAnswers}}" wx:key="index">
        <view class="info-grid-item">
          <view class="info-grid-label">{{item.question}}</view>
          <!-- è§†é¢‘ç±»å‹æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨ -->
          <view wx:if="{{item.type === 'video' && item.answer && item.answer !== 'æœªå¡«å†™'}}" class="video-answer">
            <video 
              class="answer-video" 
              src="{{item.answer}}" 
              controls 
              show-center-play-btn
              enable-play-gesture
            ></video>
          </view>
          <!-- å…¶ä»–ç±»å‹æ˜¾ç¤ºæ–‡æœ¬ç­”æ¡ˆ -->
          <view wx:else class="info-grid-value">{{item.answer || 'æœªå¡«å†™'}}</view>
        </view>
      </block>
    </view>
  </view>

  <!-- è¯¦ç»†éšè®¿å†…å®¹ï¼ˆåŠŸèƒ½è¯„åˆ†/é‡è¡¨ï¼‰ -->
  <view class="section-header">
    <view class="section-title">è¯¦ç»†éšè®¿å†…å®¹</view>
    <view class="section-count" wx:if="{{record.functionalAssessments.length > 0}}">{{record.functionalAssessments.length}}ä¸ªåŠŸèƒ½</view>
    <view class="section-count" wx:else>æš‚æ— é‡è¡¨</view>
  </view>

  <view class="functional-assessments" wx:if="{{record.functionalAssessments.length > 0}}">
    <view class="assessment-card" wx:for="{{record.functionalAssessments}}" wx:key="id">
      <view class="assessment-header">
        <view class="assessment-icon">ğŸ“Š</view>
        <view class="assessment-info">
          <view class="assessment-title-row">
            <view class="assessment-title">{{item.title}}</view>
            <view class="assessment-score" wx:if="{{item.totalScore !== undefined}}">
              <text class="score-label">æ€»åˆ†</text>
              <text class="score-value">{{item.totalScore}}åˆ†</text>
            </view>
          </view>
          <view class="assessment-description" wx:if="{{item.description}}">{{item.description}}</view>
        </view>
      </view>
      
      <view class="assessment-questions">
        <view class="assessment-question-item" wx:for="{{item.questions}}" wx:key="index" wx:for-item="qItem">
          <view class="question-label">{{qItem.question}}</view>
          <!-- è§†é¢‘ç±»å‹æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨ -->
          <view wx:if="{{qItem.type === 'video' && qItem.videoUrl}}" class="video-answer">
            <video 
              class="answer-video" 
              src="{{qItem.videoUrl}}" 
              controls 
              show-center-play-btn
              enable-play-gesture
            ></video>
          </view>
          <!-- å…¶ä»–ç±»å‹æ˜¾ç¤ºæ–‡æœ¬ç­”æ¡ˆ -->
          <view wx:else class="question-answer">{{qItem.answer || 'æœªå¡«å†™'}}</view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ— é‡è¡¨æ•°æ®æç¤º -->
  <view class="empty-tip" wx:if="{{record.functionalAssessments.length === 0}}">
    <text>è¯¥éšè®¿è®°å½•æš‚æ— åŠŸèƒ½è¯„åˆ†é‡è¡¨æ•°æ®</text>
  </view>

  <!-- AIåˆ†ææŠ¥å‘Š -->
  <view class="section-header">
    <view class="section-title">AIåˆ†ææŠ¥å‘Š</view>
    <view class="ai-status-badge" wx:if="{{aiAnalyzing}}">åˆ†æä¸­</view>
    <view class="ai-status-badge completed" wx:else>å·²å®Œæˆ</view>
  </view>

  <view class="ai-report-card">
    <block wx:if="{{aiAnalyzing}}">
      <view class="ai-loading">
        <view class="loading-icon">ğŸ¤–</view>
        <view class="loading-text">AIæ­£åœ¨åˆ†ææ‚£è€…æ•°æ®...</view>
        <view class="loading-progress">
          <view class="progress-bar" style="width: {{aiProgress}}%"></view>
        </view>
      </view>
    </block>
    
    <block wx:else>
      <!-- æ— AIæŠ¥å‘Šæç¤º -->
      <view wx:if="{{!record.aiReport.summary && (!record.aiReport.details || record.aiReport.details.length === 0) && (!record.aiReport.suggestions || record.aiReport.suggestions.length === 0)}}" class="empty-tip">
        <text>AIåˆ†ææŠ¥å‘Šæš‚æœªç”Ÿæˆ</text>
      </view>
      
      <block wx:else>
        <!-- ç»¼åˆè¯„ä¼° -->
        <view class="report-section" wx:if="{{record.aiReport.summary}}">
          <view class="report-section-title">ç»¼åˆè¯„ä¼°</view>
          <view class="report-content">{{record.aiReport.summary}}</view>
        </view>

        <!-- è¯¦ç»†åˆ†æ -->
        <view class="report-section" wx:if="{{record.aiReport.details && record.aiReport.details.length > 0}}">
          <view class="report-section-title">è¯¦ç»†åˆ†æ</view>
          <view class="analysis-item" wx:for="{{record.aiReport.details}}" wx:key="index">
            <view class="analysis-label">{{item.label}}</view>
            <view class="analysis-value">{{item.value}}</view>
          </view>
        </view>

        <!-- åŒ»ç–—å»ºè®® -->
        <view class="report-section" wx:if="{{record.aiReport.suggestions && record.aiReport.suggestions.length > 0}}">
          <view class="report-section-title">åŒ»ç–—å»ºè®®</view>
          <view class="suggestions-list">
            <view class="suggestion-item" wx:for="{{record.aiReport.suggestions}}" wx:key="index">
              <view class="suggestion-dot"></view>
              <text class="suggestion-text">{{item}}</text>
            </view>
          </view>
        </view>
      </block>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="report-actions">
        <view class="action-button primary" bindtap="savePDF" disabled="{{pdfGenerating}}">
          <text class="button-text">{{pdfGenerating ? 'ç”Ÿæˆä¸­...' : 'ä¿å­˜ä¸ºPDF'}}</text>
        </view>
        <view class="action-button" bindtap="sharePDF" disabled="{{pdfGenerating}}">
          <text class="button-text">åˆ†äº«æŠ¥å‘Š</text>
        </view>
      </view>
    </block>
  </view>
</view>
