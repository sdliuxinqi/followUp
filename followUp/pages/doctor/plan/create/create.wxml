<!--pages/doctor/plan/create/create.wxml-->
<wxs module="utils">
  // è®¡ç®—é€‰ä¸­çš„é—®é¢˜æ€»æ•°
  var getSelectedQuestionsCount = function(availableQuestions, assessmentScales) {
    var count = 0;
    
    // è®¡ç®—åŸºç¡€é—®é¢˜
    for (var i = 0; i < availableQuestions.length; i++) {
      if (availableQuestions[i].selected) {
        count++;
      }
    }
    
    // è®¡ç®—é‡è¡¨é—®é¢˜
    for (var i = 0; i < assessmentScales.length; i++) {
      var questions = assessmentScales[i].questions;
      for (var j = 0; j < questions.length; j++) {
        if (questions[j].selected) {
          count++;
        }
      }
    }
    
    return count;
  };
  
  // è·å–é€‰ä¸­çš„æ—¶é—´æ ‡ç­¾ï¼ˆå·²åºŸå¼ƒï¼Œç°åœ¨æ”¯æŒå¤šé€‰ï¼‰
  var getSelectedTimeLabel = function(timeOptions, timeTypes) {
    if (!timeTypes || timeTypes.length === 0) {
      return '';
    }
    var labels = [];
    for (var i = 0; i < timeOptions.length; i++) {
      if (timeTypes.indexOf(timeOptions[i].value) !== -1) {
        labels.push(timeOptions[i].label);
      }
    }
    return labels.join('ã€');
  };
  
  // åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥
  var canGoNext = function(currentStep, formData, availableQuestions, assessmentScales) {
    if (currentStep === 0) {
      // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥è®¡åˆ’åç§°å’Œæ˜¯å¦é€‰æ‹©äº†æ—¶é—´èŠ‚ç‚¹
      var title = formData.title || '';
      var timeTypes = formData.timeTypes || [];
      return title.trim() !== '' && timeTypes.length > 0;
    } else if (currentStep === 1) {
      // ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†éšè®¿å†…å®¹
      // è®¡ç®—é€‰ä¸­çš„é—®é¢˜æ€»æ•°
      var selectedCount = getSelectedQuestionsCount(availableQuestions, assessmentScales);
      return selectedCount > 0;
    }
    return true;
  };
  
  module.exports = {
    getSelectedQuestionsCount: getSelectedQuestionsCount,
    getSelectedTimeLabel: getSelectedTimeLabel,
    canGoNext: canGoNext
  };
</wxs>

<view class="page-container">
  <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
  <view class="steps">
    <view class="step-item {{currentStep === 0 ? 'active' : ''}} {{currentStep > 0 ? 'completed' : ''}}">
      <view class="step-number">
        <text wx:if="{{currentStep > 0}}" class="step-icon">âœ“</text>
        <text wx:else>1</text>
      </view>
      <view class="step-text">é€‰æ‹©éšè®¿æ—¥æœŸ</view>
    </view>
    <view class="step-line {{currentStep >= 1 ? 'active' : ''}}"></view>
    <view class="step-item {{currentStep === 1 ? 'active' : ''}} {{currentStep > 1 ? 'completed' : ''}}">
      <view class="step-number">
        <text wx:if="{{currentStep > 1}}" class="step-icon">âœ“</text>
        <text wx:else>2</text>
      </view>
      <view class="step-text">é€‰æ‹©éšè®¿å†…å®¹</view>
    </view>
    <view class="step-line {{currentStep >= 2 ? 'active' : ''}}"></view>
    <view class="step-item {{currentStep === 2 ? 'active' : ''}}">
      <view class="step-number">3</view>
      <view class="step-text">å®Œæˆåˆ›å»º</view>
    </view>
  </view>

  <!-- æ­¥éª¤å†…å®¹ -->
  <view class="step-content">
    <!-- æ­¥éª¤1ï¼šé€‰æ‹©éšè®¿æ—¥æœŸå’Œè®¡åˆ’åç§° -->
    <view class="step-panel" wx:if="{{currentStep === 0}}">
      <view class="panel-header">
        <text class="panel-title">éšè®¿è®¡åˆ’åç§°</text>
        <text class="panel-subtitle">è¯·è¾“å…¥ä¸€ä¸ªæ˜“äºè¯†åˆ«çš„è®¡åˆ’åç§°</text>
      </view>
      <input class="plan-title-input" placeholder="ä¾‹å¦‚ï¼šè†å…³èŠ‚æœ¯ååº·å¤éšè®¿" value="{{formData.title}}" bindinput="onTitleInput" />
      
      <view class="panel-header">
        <text class="panel-title">é€‰æ‹©éšè®¿æ—¶é—´èŠ‚ç‚¹</text>
        <text class="panel-subtitle">è¯·é€‰æ‹©é€‚åˆçš„éšè®¿æ—¶é—´ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰</text>
      </view>
      
      <!-- é€‰æ‹©æ—¶é—´ç‚¹æŒ‰é’® -->
      <view class="time-select-btn" bindtap="openTimeModal">
        <text class="btn-text">é€‰æ‹©æ—¶é—´ç‚¹</text>
        <text class="btn-arrow">â€º</text>
      </view>
      
      <!-- å·²é€‰æ‹©çš„æ—¶é—´ç‚¹æ˜¾ç¤º -->
      <view class="selected-times" wx:if="{{formData.timeTypes && formData.timeTypes.length > 0}}">
        <block wx:for="{{timeOptions}}" wx:key="value" wx:for-item="option">
          <view class="selected-time-tag" wx:if="{{option.selected}}">
            <text>{{option.label}}</text>
          </view>
        </block>
      </view>
    </view>

    <!-- æ­¥éª¤2ï¼šé€‰æ‹©éšè®¿å†…å®¹ -->
    <view class="step-panel" wx:if="{{currentStep === 1}}">
      <!-- ä¸€èˆ¬çŠ¶æ€ï¼ˆå¿…é€‰ï¼‰ -->
      <view class="panel-header">
        <text class="panel-title">ä¸€èˆ¬çŠ¶æ€<text class="required-star">*</text></text>
        <text class="panel-subtitle">ä»¥ä¸‹å†…å®¹ä¸ºå¿…å¡«é¡¹ï¼Œå°†è‡ªåŠ¨åŒ…å«åœ¨éšè®¿è®¡åˆ’ä¸­</text>
      </view>
      <view class="question-grid">
        <block wx:for="{{availableQuestions}}" wx:key="id">
          <view wx:if="{{item.group === 'basic'}}" class="question-grid-item selected required-item">
            <view class="question-grid-title">
              <text class="required-indicator">*</text>
              <text>{{item.title}}</text>
            </view>
            <view class="question-grid-badge">å¿…å¡«</view>
          </view>
        </block>
      </view>

      <!-- æ´»åŠ¨è¯„ä¼°ï¼ˆå¯é€‰ï¼‰ -->
      <view class="panel-header">
        <text class="panel-title">æ´»åŠ¨è¯„ä¼°ï¼ˆå¯é€‰ï¼‰</text>
        <text class="panel-subtitle">å¯é€‰æ‹©éœ€è¦è¯„ä¼°çš„æ´»åŠ¨é¡¹ç›®</text>
      </view>
      <view class="question-list">
        <block wx:for="{{availableQuestions}}" wx:key="id">
          <view wx:if="{{item.group === 'activity'}}"
                class="question-item {{item.selected ? 'selected' : ''}}"
                bindtap="toggleQuestion"
                data-id="{{item.id}}">
            <view class="question-info">
              <view class="question-title">{{item.title}}</view>
            </view>
            <view class="question-checkbox">
              {{item.selected ? 'âœ“' : ''}}
            </view>
          </view>
        </block>
      </view>

      <!-- åŠŸèƒ½è¯„åˆ† / é‡è¡¨ï¼ˆå¯é€‰ï¼‰ -->
      <view class="panel-header">
        <text class="panel-title">åŠŸèƒ½è¯„åˆ†ï¼ˆå¯é€‰ï¼‰</text>
        <text class="panel-subtitle">å¯é€‰æ‹©éœ€è¦çš„è¯„ä¼°é‡è¡¨</text>
      </view>
      <view class="scale-list">
        <block wx:for="{{assessmentScales}}" wx:key="id">
          <view class="scale-item {{item.allSelected ? 'selected' : ''}}">
            <view class="scale-header">
              <view class="scale-checkbox" bindtap="toggleScaleQuestions" data-scale-id="{{item.id}}">
                <text wx:if="{{item.allSelected}}">âœ“</text>
              </view>
              <view class="scale-info" bindtap="toggleScaleQuestions" data-scale-id="{{item.id}}">
                <view class="scale-title">{{item.title}}</view>
                <view class="scale-description">{{item.description}}</view>
              </view>
              <view class="scale-arrow" catchtap="toggleScale" data-id="{{item.id}}">
                {{item.expanded ? 'â–¼' : 'â–¶'}}
              </view>
            </view>
            
            <!-- é‡è¡¨é—®é¢˜åˆ—è¡¨ï¼ˆåªè¯»å±•ç¤ºï¼‰ -->
            <view class="scale-questions" wx:if="{{item.expanded}}">
              <view class="scale-questions-header">
                <text class="questions-count">åŒ…å« {{item.questions.length}} ä¸ªé—®é¢˜</text>
              </view>
              <block wx:for="{{item.questions}}" wx:key="id" wx:for-item="question" wx:for-index="qIndex">
                <view class="question-item-readonly">
                  <view class="question-info">
                    <view class="question-header-row">
                      <view class="question-type">{{question.typeName}}</view>
                      <view class="question-number">ç¬¬{{qIndex + 1}}é¢˜</view>
                    </view>
                    <view class="question-title">
                      <text>{{question.text}}</text>
                    </view>
                    <!-- æ ¹æ®é—®é¢˜ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ·å¼ -->
                    <view class="question-preview" wx:if="{{question.type === 'slider'}}">
                      <text>èŒƒå›´ï¼š{{question.min}}-{{question.max}}ï¼Œæ­¥é•¿ï¼š{{question.step}}</text>
                    </view>
                    <view class="question-preview" wx:if="{{question.type === 'radio' || question.type === 'checkbox'}}">
                      <text>{{question.options.length}}ä¸ªé€‰é¡¹</text>
                    </view>
                  </view>
                </view>
              </block>
            </view>
          </view>
        </block>
      </view>

      <!-- AI è¾…åŠ©æ™ºèƒ½è¯„ä¼°ï¼ˆå¯é€‰ï¼‰ -->
      <view class="panel-header">
        <text class="panel-title">AIè¾…åŠ©æ™ºèƒ½è¯„ä¼°ï¼ˆå¯é€‰ï¼‰</text>
        <text class="panel-subtitle">å¯ç”¨AIæ™ºèƒ½åˆ†æåŠŸèƒ½</text>
      </view>
      <view class="question-list">
        <block wx:for="{{availableQuestions}}" wx:key="id">
          <view wx:if="{{item.group === 'ai'}}"
                class="question-item {{item.selected ? 'selected' : ''}}"
                bindtap="toggleQuestion"
                data-id="{{item.id}}">
            <view class="question-info">
              <view class="question-title">{{item.title}}</view>
            </view>
            <view class="question-checkbox">
              {{item.selected ? 'âœ“' : ''}}
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- æ­¥éª¤3ï¼šå®Œæˆåˆ›å»º -->
    <view class="step-panel" wx:if="{{currentStep === 2}}">
      <view class="success-header">
        <view class="success-icon">âœ“</view>
        <view class="success-title">ç¡®è®¤éšè®¿è®¡åˆ’ä¿¡æ¯</view>
        <view class="success-subtitle">è¯·ç¡®è®¤ä»¥ä¸‹ä¿¡æ¯æ— è¯¯åï¼Œç‚¹å‡»"åˆ›å»ºéšè®¿è®¡åˆ’"æŒ‰é’®</view>
      </view>
      
      <view class="plan-summary">
        <view class="summary-card">
          <view class="summary-icon">ğŸ“‹</view>
          <view class="summary-content">
            <view class="summary-label">è®¡åˆ’åç§°</view>
            <view class="summary-value">{{formData.title}}</view>
          </view>
        </view>
        
        <view class="summary-card">
          <view class="summary-icon">ğŸ“…</view>
          <view class="summary-content">
            <view class="summary-label">æ—¶é—´èŠ‚ç‚¹</view>
            <view class="summary-value">{{utils.getSelectedTimeLabel(timeOptions, formData.timeTypes)}}</view>
          </view>
        </view>
        
        <view class="summary-card">
          <view class="summary-icon">ğŸ“</view>
          <view class="summary-content">
            <view class="summary-label">åŒ…å«é¡¹ç›®</view>
            <view class="summary-value">{{utils.getSelectedQuestionsCount(availableQuestions, assessmentScales)}}ä¸ªé¡¹ç›®</view>
          </view>
        </view>
      </view>
      
      <view class="summary-tip">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">åˆ›å»ºåï¼Œæ‚£è€…å°†èƒ½å¤Ÿçœ‹åˆ°å¹¶å¡«å†™è¿™ä»½éšè®¿è®¡åˆ’</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æŒ‰é’® -->
  <view class="bottom-buttons">
    <button class="prev-button" wx:if="{{currentStep > 0}}" bindtap="prevStep">ä¸Šä¸€æ­¥</button>
    <button class="next-button" wx:if="{{currentStep < 2}}" bindtap="nextStep" disabled="{{!utils.canGoNext(currentStep, formData, availableQuestions, assessmentScales)}}">ä¸‹ä¸€æ­¥</button>
    <button class="create-button" wx:if="{{currentStep === 2}}" bindtap="createPlan" loading="{{loading}}">åˆ›å»ºéšè®¿è®¡åˆ’</button>
  </view>

  <!-- æ—¶é—´é€‰æ‹©å¼¹çª— -->
  <view class="time-modal-mask" wx:if="{{showTimeModal}}" bindtap="closeTimeModal">
    <view class="time-modal-container" catchtap="stopPropagation">
      <view class="time-modal-header">
        <text class="time-modal-title">é€‰æ‹©éšè®¿æ—¶é—´èŠ‚ç‚¹</text>
        <text class="time-modal-close" bindtap="closeTimeModal">âœ•</text>
      </view>
      <scroll-view class="time-modal-body" scroll-y>
        <view class="time-modal-list">
          <view class="time-modal-item {{item.selected ? 'selected' : ''}} {{item.isDaily ? 'daily-item' : ''}}" 
                wx:for="{{timeOptions}}" 
                wx:key="value"
                bindtap="toggleTimeOption"
                data-index="{{index}}">
            <view class="time-modal-checkbox">
              <text wx:if="{{item.selected}}">âœ“</text>
            </view>
            <text class="time-modal-label {{item.isDaily ? 'daily-label' : ''}}">{{item.label}}</text>
          </view>
        </view>
      </scroll-view>
      <view class="time-modal-footer">
        <button class="time-modal-confirm" bindtap="confirmTimeSelection">ç¡®è®¤</button>
      </view>
    </view>
  </view>
</view>