<!--pages/patient/fill/fill.wxml-->
<wxs module="utils">
  // è·å–æ€§åˆ«æ˜¾ç¤ºæ–‡æœ¬
  function getGenderText(item, answerValue) {
    if (!item || !item.options || !answerValue) {
      return '';
    }
    var options = item.options;
    for (var i = 0; i < options.length; i++) {
      if (options[i].id === answerValue) {
        return options[i].text;
      }
    }
    return '';
  }
  
  module.exports = {
    getGenderText: getGenderText
  };
</wxs>

<view class="page-container">
  <view class="header">
    <view class="title">{{planTitle}}</view>
  </view>

  <!-- é—®å·å†…å®¹ -->
  <view class="question-container">
    <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ï¼ˆå§“åã€æ€§åˆ«ã€å‡ºç”Ÿæ—¥æœŸã€èº«é«˜ã€ä½é™¢å·ã€ä½é™¢æ—¥æœŸã€è”ç³»æ–¹å¼ï¼Œåªè¯»ï¼‰ -->
    <view class="basic-info-card">
      <view class="basic-info-grid">
        <view class="basic-info-item" wx:for="{{basicInfo}}" wx:key="id">
          <view class="basic-info-label">{{item.title}}</view>
          <view class="basic-info-input-wrapper">
            <input wx:if="{{item.type === 'text'}}" 
              class="basic-info-input {{item.readonly ? 'readonly-input' : ''}}" 
              placeholder="è¯·è¾“å…¥" 
              bindinput="onAnswerChange" 
              data-question-id="{{item.id}}" 
              value="{{answers[item.id] || ''}}"
              placeholder-class="placeholder-text"
              disabled="{{item.readonly}}"
            />
            <!-- åªè¯»çš„ single ç±»å‹å­—æ®µï¼ˆå¦‚æ€§åˆ«ï¼‰æ˜¾ç¤ºä¸ºæ–‡æœ¬ -->
            <view wx:if="{{item.type === 'single' && item.readonly}}" class="basic-info-text">
              <text class="basic-info-text-value">{{utils.getGenderText(item, answers[item.id])}}</text>
            </view>
            <!-- å¯ç¼–è¾‘çš„ single ç±»å‹å­—æ®µæ˜¾ç¤ºä¸º radio -->
            <view wx:if="{{item.type === 'single' && !item.readonly}}" class="basic-info-select">
              <radio-group 
                bindchange="onSingleSelect" 
                data-question-id="{{item.id}}"
                disabled="{{item.readonly}}"
              >
                <label class="basic-info-option" wx:for="{{item.options}}" wx:for-item="option" wx:key="id">
                  <radio value="{{option.id}}" checked="{{answers[item.id] === option.id}}" disabled="{{item.readonly}}" />
                  <text class="basic-info-option-text">{{option.text}}</text>
                </label>
              </radio-group>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- éœ€å¡«å†™çš„å­—æ®µå¡ç‰‡ï¼ˆä½“é‡ã€æ‰‹æœ¯æ—¥æœŸã€éšè®¿æ—¥æœŸï¼‰ -->
    <view class="fillable-info-card" wx:if="{{fillableInfo.length > 0}}">
      <view class="fillable-info-grid">
        <view class="fillable-info-item" wx:for="{{fillableInfo}}" wx:key="id">
          <view class="fillable-info-label">{{item.title}}</view>
          <view class="fillable-info-input-wrapper">
            <input 
              class="fillable-info-input" 
              placeholder="è¯·è¾“å…¥" 
              bindinput="onAnswerChange" 
              data-question-id="{{item.id}}" 
              value="{{answers[item.id] || ''}}"
              placeholder-class="placeholder-text"
            />
          </view>
        </view>
      </view>
    </view>

    <!-- å…¶ä»–é—®é¢˜ -->
    <view class="question-item" wx:for="{{questions}}" wx:for-item="question" wx:key="id">
      <view class="question-label">{{question.title}}</view>

      <!-- è§†é¢‘ä¸Šä¼  -->
      <view wx:if="{{question.type === 'video'}}" class="video-upload">
        <view wx:if="{{!answers[question.id]}}" class="upload-btn" 
          bindtap="onVideoUpload" 
          data-question-id="{{question.id}}"
        >
          <text>ä¸Šä¼ è§†é¢‘</text>
        </view>
        <view wx:else class="video-preview">
          <video src="{{answers[question.id]}}" controls></video>
          <view class="delete-btn" bindtap="onVideoDelete" data-question-id="{{question.id}}">
            åˆ é™¤è§†é¢‘
          </view>
        </view>
      </view>
    </view>

    <!-- åŠŸèƒ½è¯„åˆ†ï¼ˆæŒ‰é‡è¡¨åˆ†ç»„ï¼‰ -->
    <view class="functional-assessments" wx:if="{{functionalAssessments.length > 0}}">
      <view class="assessment-card" wx:for="{{functionalAssessments}}" wx:key="id">
        <view class="assessment-header">
          <view class="assessment-icon">ğŸ“Š</view>
          <view class="assessment-info">
            <view class="assessment-title">{{item.title}}</view>
            <view class="assessment-description" wx:if="{{item.description}}">{{item.description}}</view>
          </view>
        </view>
        
        <view class="assessment-questions">
          <view class="assessment-question-item" wx:for="{{item.questions}}" wx:key="id" wx:for-item="qItem">
            <view class="assessment-question-label">{{qItem.text}}</view>

            <!-- æ»‘æ†è¯„åˆ† -->
            <view wx:if="{{qItem.type === 'slider'}}" class="slider-container">
              <slider class="answer-slider" 
                min="{{qItem.min || 0}}" 
                max="{{qItem.max || 10}}" 
                step="{{qItem.step || 1}}"
                value="{{answers[qItem.id] !== undefined ? answers[qItem.id] : (qItem.min || 0)}}" 
                bindchange="onSliderChange" 
                data-question-id="{{qItem.id}}"
              />
              <text class="slider-value">{{answers[qItem.id] !== undefined ? answers[qItem.id] : (qItem.min || 0)}}åˆ†</text>
            </view>

            <!-- å•é€‰é¢˜ï¼ˆå¸¦scoreï¼‰ -->
            <view wx:if="{{qItem.type === 'radio'}}" class="options-container">
              <radio-group class="radio-group" 
                bindchange="onSingleSelect" 
                data-question-id="{{qItem.id}}"
              >
                <label class="option-item" wx:for="{{qItem.options}}" wx:for-item="option" wx:key="id">
                  <radio value="{{option.id}}" checked="{{answers[qItem.id] === option.id}}" />
                  <view class="option-content">
                    <text class="option-text">{{option.text}}</text>
                    <text class="option-score" wx:if="{{option.score !== undefined}}">({{option.score}}åˆ†)</text>
                  </view>
                </label>
              </radio-group>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="submit-container">
    <button class="submit-btn" bindtap="submitFollowUp" loading="{{submitting}}">
      æäº¤éšè®¿
    </button>
  </view>

  <!-- è§†é¢‘æ‹æ‘„æç¤ºå¼¹çª— -->
  <view class="video-tip-mask" wx:if="{{showVideoTip}}" bindtap="cancelVideoTip">
    <view class="video-tip-container" catchtap="stopPropagation">
      <view class="video-tip-header">
        <text class="video-tip-title">æ‹æ‘„æç¤º</text>
        <text class="video-tip-close" bindtap="cancelVideoTip">Ã—</text>
      </view>
      <view class="video-tip-content">
        <text class="video-tip-text">{{videoTipContent}}</text>
      </view>
      <view class="video-tip-footer">
        <button class="video-tip-cancel-btn" bindtap="cancelVideoTip">å–æ¶ˆ</button>
        <button class="video-tip-confirm-btn" bindtap="confirmVideoTip">å¼€å§‹æ‹æ‘„</button>
      </view>
    </view>
  </view>
</view>